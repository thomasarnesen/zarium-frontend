<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- Favicon and App Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="msapplication-TileImage" content="/mstile-144x144.png">
    <meta name="msapplication-config" content="/browserconfig.xml">
    
    <!-- reCAPTCHA API -->
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
    
    <!-- Improved styling for loading state -->
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }
      .initial-loader {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100vh;
        background-color: #f8fafc;
        flex-direction: column;
        text-align: center;
      }
      .initial-loader-content {
        padding: 20px;
        max-width: 500px;
      }
      .initial-loader h1 {
        font-size: 24px;
        color: #059669;
        margin-bottom: 16px;
      }
      .spinner {
        width: 40px;
        height: 40px;
        margin: 20px auto;
        border: 4px solid rgba(5, 150, 105, 0.2);
        border-radius: 50%;
        border-top-color: #059669;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    
    <!-- Cache control for Safari/iOS -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Primary Meta Tags -->
    <title>Zarium | AI Excel Generator | Create Spreadsheets in Seconds</title>
    <meta name="description" content="Transform ideas into professional Excel spreadsheets with AI in seconds. Upload existing files or create new ones from scratch with Zarium." />
    <meta name="keywords" content="AI Excel generator, spreadsheet creator, Excel automation, AI spreadsheet, Excel formulas, Excel macros" />
    <meta name="robots" content="index, follow" />
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#057857" />
    <meta name="msapplication-navbutton-color" content="#057857" />
    <meta name="apple-mobile-web-app-status-bar-style" content="#057857" />
    
    <!-- Canonical URL - support both www and non-www -->
    <link rel="canonical" href="https://www.zarium.dev/" />
   
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://www.zarium.dev/" />
    <meta property="og:title" content="Zarium | AI Excel Generator | Create Spreadsheets in Seconds" />
    <meta property="og:description" content="Transform ideas into professional Excel spreadsheets with AI in seconds. Upload existing files or create new ones from scratch with Zarium." />
    <meta property="og:image" content="https://www.zarium.dev/og-image.png" />
    <meta property="og:site_name" content="Zarium" />
    
    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="https://www.zarium.dev/" />
    <meta name="twitter:title" content="Zarium | AI Excel Generator | Create Spreadsheets in Seconds" />
    <meta name="twitter:description" content="Transform ideas into professional Excel spreadsheets with AI in seconds. Upload existing files or create new ones from scratch with Zarium." />
    <meta name="twitter:image" content="https://www.zarium.dev/twitter-image.png" />

   
    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://zarium-app-ddbnb4egcpf4e6b0.westeurope-01.azurewebsites.net" />
    <link rel="preconnect" href="https://js.stripe.com" crossorigin />
    
    <!-- Stripe Integration -->
    <script src="https://js.stripe.com/v3/" defer></script>
    
    <!-- Structured Data - JSON-LD -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Zarium",
      "applicationCategory": "BusinessApplication",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD",
        "description": "Free trial available"
      },
      "operatingSystem": "Web",
      "description": "AI-powered Excel generator that creates complete spreadsheets with 3D graphs in seconds or enhances your existing Excel files."
    }
    </script>
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "name": "Zarium",
      "url": "https://www.zarium.dev/",
      "logo": "https://www.zarium.dev/favicon-32x32.png"
    }
    </script>

    <!-- Improved error detection script -->
    <script>
      // Initialize error tracking
      window.__zarium_errors = [];
      window.__zarium_lastErrorTime = 0;
      
      // Global error handler to catch JS errors
      window.addEventListener('error', function(event) {
        const now = Date.now();
        window.__zarium_errors.push({
          message: event.message,
          time: now
        });
        window.__zarium_lastErrorTime = now;
        
        console.error('Global error:', event.message);
      });
      
      // If the page is blank after 10 seconds, show an error message
      window.addEventListener('DOMContentLoaded', function() {
        var timeout = setTimeout(function() {
          var root = document.getElementById('root');
          if (root && (!root.children || root.children.length === 0 || 
              root.innerHTML.includes('Loading application'))) {
            console.error('Application load timeout triggered');
            
            // Check if we have recent errors
            const hasRecentErrors = window.__zarium_errors && 
              window.__zarium_errors.some(err => (Date.now() - err.time) < 10000);
            
            // Show an appropriate error message
            if (hasRecentErrors) {
              root.innerHTML = `
                <div class="initial-loader">
                  <div class="initial-loader-content">
                    <h1>Error Loading Zarium</h1>
                    <p>We encountered errors while loading the application.</p>
                    <p>This could be due to browser compatibility issues or network problems.</p>
                    <div style="margin-top: 20px;">
                      <button onclick="window.location.reload()" style="padding:8px 16px;background-color:#059669;color:white;border:none;border-radius:6px;cursor:pointer;margin-right:10px;">
                        Reload page
                      </button>
                      <button onclick="localStorage.clear(); sessionStorage.clear(); document.cookie.split(';').forEach(c => document.cookie = c.replace(/^ +/, '').replace(/=.*/, '=;expires=' + new Date().toUTCString() + ';path=/')); window.location.href='/';" style="padding:8px 16px;background-color:#f3f4f6;color:#1f2937;border:1px solid #d1d5db;border-radius:6px;cursor:pointer;">
                        Clear data & start fresh
                      </button>
                    </div>
                  </div>
                </div>
              `;
            } else {
              root.innerHTML = `
                <div class="initial-loader">
                  <div class="initial-loader-content">
                    <h1>Loading Zarium is taking longer than expected</h1>
                    <p>This might be due to network issues or high server load.</p>
                    <div style="margin-top: 20px;">
                      <button onclick="window.location.reload()" style="padding:8px 16px;background-color:#059669;color:white;border:none;border-radius:6px;cursor:pointer;">
                        Reload page
                      </button>
                    </div>
                  </div>
                </div>
              `;
            }
          }
        }, 10000);
        
        // If the app loads correctly, clear timeout
        var observer = new MutationObserver(function(mutations) {
          const root = document.getElementById('root');
          if (root && root.children.length > 0 && 
              !root.innerHTML.includes('Loading application') &&
              !root.innerHTML.includes('initial-loader')) {
            clearTimeout(timeout);
            observer.disconnect();
          }
        });
        
        observer.observe(document.getElementById('root'), { childList: true, subtree: true });
      });
    </script>
    
    <!-- Safari/iOS Authentication Fix - Final Version -->
    <script>
      // Safari/iOS detection and fix for authentication issues
      document.addEventListener('DOMContentLoaded', function() {
        // Detect Safari or iOS devices
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) || 
                        /iphone|ipad|ipod/i.test(navigator.userAgent);
        
        if (isSafari) {
          console.log("Safari/iOS browser detected - enabling compatibility mode");
          
          // Fix the token duplication issue
          const originalFetch = window.fetch;
          window.fetch = function(url, options = {}) {
            // Default options
            options = options || {};
            
            if (typeof url === 'string') {
              // Special handling for authentication endpoints
              if (url.includes('/api/') && !url.includes('/api/debug')) {
                console.log("Processing request to:", url);
                
                // Get token from localStorage
                let token = null;
                try {
                  const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
                  token = authData.token;
                } catch (e) {
                  console.warn("Error accessing localStorage:", e);
                }
                
                // Only proceed with token modifications if we have a token
                if (token) {
                  // Create URL object for manipulation
                  const urlObj = new URL(url, window.location.origin);
                  
                  // Check if token is already in URL, only add if not present
                  if (!urlObj.searchParams.has('token')) {
                    urlObj.searchParams.append('token', token);
                    console.log("Added token to URL params");
                  }
                  
                  // Update URL with our modifications
                  url = urlObj.toString();
                  
                  // Initialize headers if not already set
                  options.headers = options.headers || {};
                  
                  // Add Authorization header if not already present
                  if (!options.headers.Authorization) {
                    options.headers.Authorization = `Bearer ${token}`;
                    console.log("Added Authorization header");
                  }
                }
                
                // Always include credentials
                options.credentials = 'include';
                
                // Special case for refresh-token on Safari
                if (url.includes('/api/refresh-token') && options.method === 'POST') {
                  // Use GET method instead of POST for Safari
                  options.method = 'GET';
                  console.log("Converting POST to GET for refresh-token on Safari");
                }
              }
            }
            
            // Call original fetch with our modifications
            return originalFetch.call(window, url, options)
              .then(response => {
                // If this was a token refresh, extract and store the new token
                if (typeof url === 'string' && url.includes('/api/refresh-token') && response.ok) {
                  response.clone().json().then(data => {
                    if (data && data.token) {
                      try {
                        console.log("Storing new token from refresh response");
                        const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
                        authData.token = data.token;
                        localStorage.setItem('authUser', JSON.stringify(authData));
                        
                        // Update auth info with other data too
                        if (data.id) authData.id = data.id;
                        if (data.email) authData.email = data.email;
                        if (data.planType) authData.planType = data.planType;
                        if (data.tokens) authData.tokens = data.tokens;
                        if (data.displayName) authData.displayName = data.displayName;
                        
                        localStorage.setItem('authUser', JSON.stringify(authData));
                      } catch (e) {
                        console.error("Error storing refreshed token:", e);
                      }
                    }
                  }).catch(e => console.error("Error parsing token refresh response:", e));
                }
                
                return response;
              });
          };
          
          // Implement a function to immediately apply the stored token to all subsequent requests
          window.applyStoredToken = function() {
            let token = null;
            try {
              const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
              token = authData.token;
              
              if (token) {
                console.log("Applied stored token to future requests");
                // This function will be used after successful token refresh
                return true;
              }
            } catch (e) {
              console.error("Error in applyStoredToken:", e);
            }
            return false;
          };
          
          // Force a token refresh on page load for Safari
          setTimeout(function() {
            // Get token from localStorage
            let token = null;
            try {
              const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
              token = authData.token;
              
              if (token) {
                console.log("Performing initial token refresh for Safari");
                fetch('/api/refresh-token', {
                  method: 'GET',
                  headers: {
                    'Authorization': `Bearer ${token}`
                  },
                  credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                  if (data && data.token) {
                    console.log("Initial token refresh successful");
                    const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
                    authData.token = data.token;
                    localStorage.setItem('authUser', JSON.stringify(authData));
                    window.applyStoredToken();
                  }
                })
                .catch(e => console.error("Initial token refresh failed:", e));
              }
            } catch (e) {
              console.error("Error in initial token refresh:", e);
            }
          }, 1000);
        }
      });
    </script>
  </head>
  <body> 
    <div id="root">
      <!-- Initial loading state shown while React loads -->
      <div class="initial-loader">
        <div class="initial-loader-content">
          <h1>Zarium</h1>
          <div class="spinner"></div>
          <p>Loading application...</p>
        </div>
      </div>
      
      <!-- reCAPTCHA container - can be positioned via CSS as needed -->
      <div id="recaptcha-container" style="display: none;">
        <div class="g-recaptcha" data-sitekey="6LdbBQErAAAAAOJtIXNhnHqRGoknYPxoa6C3oyzG"></div>
      </div>
    </div>
    <noscript>
      <div style="padding: 20px; text-align: center;">
        <h1>Zarium AI Excel Generator</h1>
        <p>Zarium is an AI-powered tool that helps you generate professional Excel spreadsheets.</p>
        <p>Please enable JavaScript to use Zarium AI.</p>
      </div>
    </noscript>
    <!-- Add cache busting parameter -->
    <script type="module" src="/src/main.tsx?v=20240325_2"></script>
    
    <script>
      // Sikkerhetsnett for innlasting
      window.addEventListener('load', function() {
        var loadTimeout = setTimeout(function() {
          var root = document.getElementById('root');
          var loaderElement = document.querySelector('.initial-loader');
          
          // Sjekk om appen fortsatt viser lasteskjermen etter 15 sekunder
          if (root && loaderElement && root.contains(loaderElement)) {
            loaderElement.innerHTML = `
              <div style="max-width:500px;padding:20px;text-align:center;">
                <h2 style="font-size:20px;color:#059669;margin-bottom:15px;">
                  Dette tar lengre tid enn forventet
                </h2>
                <p style="margin-bottom:20px;color:#555;line-height:1.5;">
                  Vi beklager forsinkelsen. Dette kan skyldes treg nettverksforbindelse.
                </p>
                <div>
                  <button onclick="window.location.reload()" style="padding:10px 20px;background-color:#059669;color:white;border:none;border-radius:4px;cursor:pointer;margin-right:10px;">
                    Oppdater siden
                  </button>
                  <button onclick="localStorage.clear();sessionStorage.clear();document.cookie.split(';').forEach(c=>document.cookie=c.replace(/^ +/,'').replace(/=.*/,'=;expires='+new Date().toUTCString()+';path=/'));window.location.href='/';" style="padding:10px 20px;background-color:#f3f4f6;color:#333;border:1px solid #ddd;border-radius:4px;cursor:pointer;">
                    Start p√• nytt
                  </button>
                </div>
              </div>
            `;
          }
        }, 15000); // 15 sekunder

        // Rydd opp hvis appen laster som den skal
        var observer = new MutationObserver(function(mutations) {
          if (!document.querySelector('.initial-loader')) {
            clearTimeout(loadTimeout);
            observer.disconnect();
          }
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
      });
    </script>
    
    <!-- reCAPTCHA initialization script -->
    <script>
      // Make reCAPTCHA available to your React application
      window.onLoadRecaptcha = function() {
        console.log("reCAPTCHA ready!");
        // Expose methods for your React app to use reCAPTCHA
        window.executeRecaptcha = function(callback) {
          try {
            grecaptcha.ready(function() {
              grecaptcha.execute('6LdbBQErAAAAAOJtIXNhnHqRGoknYPxoa6C3oyzG', {action: 'submit'})
                .then(function(token) {
                  console.log("reCAPTCHA token obtained");
                  if (typeof callback === 'function') {
                    callback(token);
                  }
                });
            });
          } catch (error) {
            console.error("reCAPTCHA execution error:", error);
            if (typeof callback === 'function') {
              callback(null, error);
            }
          }
        };
        
        // Method to get reCAPTCHA response manually
        window.getRecaptchaResponse = function() {
          try {
            return grecaptcha.getResponse();
          } catch (error) {
            console.error("Error getting reCAPTCHA response:", error);
            return null;
          }
        };
        
        // Method to reset reCAPTCHA
        window.resetRecaptcha = function() {
          try {
            grecaptcha.reset();
            console.log("reCAPTCHA reset");
          } catch (error) {
            console.error("Error resetting reCAPTCHA:", error);
          }
        };
      };
      
      // Add global callback for reCAPTCHA
      window.recaptchaCallback = function(token) {
        console.log("reCAPTCHA callback executed with token");
        const captchaEvent = new CustomEvent('recaptchaComplete', { detail: { token: token } });
        window.dispatchEvent(captchaEvent);
      };
    </script>
    
    <!-- Multi-domain Safari/iOS Authentication Fix -->
    <script>
      // Safari/iOS detection and multi-domain compatibility
      document.addEventListener('DOMContentLoaded', function() {
        // Domain compatibility - support both www and non-www
        const currentHost = window.location.hostname;
        const supportedDomains = ["www.zarium.dev", "zarium.dev"];
        const isKnownDomain = supportedDomains.includes(currentHost);
        
        console.log("Current domain:", currentHost);
        console.log("Using known domain:", isKnownDomain);
        
        // Add currentHost to list of supported domains if not already recognized
        if (!isKnownDomain) {
          supportedDomains.push(currentHost);
          console.log("Added current domain to supported list:", currentHost);
        }
        
        // Store domain info
        localStorage.setItem('current_domain', currentHost);
        localStorage.setItem('supported_domains', JSON.stringify(supportedDomains));
        
        // Detect Safari or iOS devices
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent) || 
                        /iphone|ipad|ipod/i.test(navigator.userAgent);
        
        // Initialize compatibility mode if needed
        if (isSafari) {
          console.log("Safari/iOS browser detected - enabling compatibility mode");
          // Set flag for Safari compatibility
          localStorage.setItem('using_safari_auth', 'true');
          
          // Patch fetch API for Safari compatibility
          const originalFetch = window.fetch;
          window.fetch = function(url, options = {}) {
            // Default options
            options = options || {};
            
            // Convert URL string to URL object if it's a string
            if (typeof url === 'string') {
              // Handle auth endpoints specially
              if ((url.includes('/api/refresh-token') || 
                  url.includes('/api/verify-token') ||
                  url.includes('/api/auth/')) && 
                  (options.method === 'POST' || !options.method)) {
                
                console.log("Safari compatibility: Modifying auth request", url);
                
                // Get token from localStorage if available
                let token = null;
                try {
                  const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
                  token = authData.token;
                  console.log("Found token in localStorage:", token ? "Yes" : "No");
                } catch (e) {
                  console.warn("Error accessing localStorage:", e);
                }
                
                // Create URL object for manipulation
                const urlObj = new URL(url, window.location.origin);
                
                // Add token as query parameter if available
                if (token) {
                  urlObj.searchParams.append('token', token);
                  console.log("Added token to URL params");
                }
                
                // Special handling for refresh-token endpoint on Safari
                if (isSafari && url.includes('/api/refresh-token')) {
                  // Use GET for refresh token on Safari
                  options.method = 'GET';
                  console.log("Forced GET method for Safari compatibility");
                }
                
                // Update URL with our modifications
                url = urlObj.toString();
                
                // Initialize headers if not already set
                options.headers = options.headers || {};
                
                // Add Authorization header if token available
                if (token && !options.headers.Authorization) {
                  options.headers.Authorization = `Bearer ${token}`;
                  console.log("Added Authorization header");
                }
                
                // Always include credentials for auth endpoints
                options.credentials = 'include';
              }
            }
            
            // Log the request for debugging
            const reqMethod = options.method || 'GET';
            console.log(`${reqMethod} request to: ${typeof url === 'string' ? url : url.toString()}`);
            
            // Call original fetch with modified parameters
            return originalFetch.call(window, url, options).then(response => {
              // Log response status for debugging
              console.log(`Response status: ${response.status} for ${reqMethod} ${typeof url === 'string' ? url : url.toString()}`);
              return response;
            }).catch(error => {
              console.error("Fetch error:", error);
              throw error;
            });
          };
          
          // Log success message
          console.log("Safari/iOS compatibility mode enabled successfully");
          
          // Add special token refresh function for Safari
          window.refreshTokenSafari = async function() {
            try {
              // Get current token
              let token = null;
              try {
                const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
                token = authData.token;
              } catch (e) {
                console.error("Failed to retrieve token:", e);
                return false;
              }
              
              if (!token) {
                console.error("No token available to refresh");
                return false;
              }
              
              // Build URL with token parameter for GET request
              const refreshUrl = `${window.location.origin}/api/refresh-token?token=${encodeURIComponent(token)}`;
              
              console.log("Attempting Safari token refresh...");
              const response = await fetch(refreshUrl, {
                method: 'GET',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Accept': 'application/json'
                },
                credentials: 'include'
              });
              
              if (!response.ok) {
                console.error("Safari token refresh failed:", response.status);
                return false;
              }
              
              const data = await response.json();
              
              if (data.token) {
                // Update token in localStorage
                console.log("Received new token, updating storage");
                const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
                authData.token = data.token;
                localStorage.setItem('authUser', JSON.stringify(authData));
                return true;
              } else {
                console.error("No token in refresh response");
                return false;
              }
            } catch (error) {
              console.error("Safari token refresh error:", error);
              return false;
            }
          };
        }
        
        // Add debug function for both Safari and domain issues
        window.debugAuth = function() {
          let token = "";
          try {
            const authData = JSON.parse(localStorage.getItem('authUser') || '{}');
            token = authData.token;
          } catch (e) {
            console.error("Error reading token:", e);
          }
          
          const debugInfo = {
            currentDomain: window.location.hostname,
            supportedDomains: supportedDomains,
            userAgent: navigator.userAgent,
            isSafari: isSafari,
            hasToken: !!token,
            tokenPrefix: token ? token.substring(0, 10) + "..." : "None",
            localStorage: Object.keys(localStorage),
            cookies: document.cookie.split(';').map(c => c.trim())
          };
          
          console.log("Auth Debug Info:", debugInfo);
          alert("Auth debug info printed to console");
          
          return debugInfo;
        };
      });
    </script>
  </body>
</html>